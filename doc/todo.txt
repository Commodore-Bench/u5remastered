Ultima V Remastered

Mission: Put the complete original game for the C64 on an EasyFlash cartridge
Variants:
- Do not change anything
- Allow Bugfixes
- No trainer or similar, no demo or other
- Later: add savegame manager, add trainer, add sound via banking (might be possible)
==============================================================================

ToDo

- add patching of prg files with other prg files
- identify the meaning of list, slist and tlist saving
  look in create.prg
- modify transfer.prg to read from disk
  + no disk loading available, could be necessary to redesign
- remove drive selection from main menu
  patch
- check for irq handling while loading
- improve makefile: phony labels, correct building in external directory
- idea: replace all filenames with numbers (not important right now)
  directory search is simple multiplication (well not simple, but ok)
  identification of save files is easy
  rewrite of load call everywere necessary: b:number b:argument size 0 0 0 ...

- ok make jmp table modificator
  + tool to read map files 
  + extract relevant symbol
  + patch other file
- ok implement new loading routines
  + omit saving for now
  + just loading blocks and files
- ok make tool to create bin file: 
  + define map to put together all files for bin file
  + list of files and their position in the cartridge
  + make crt file from binfile (own script or cartconv)
- ok save strategy
- ok Identify relevant code and files
- ok Learn about u5 structure
- ok Identify all kernal calls (not all, but is sufficient)
- ok identify saved location for current disk -> is requested through temp.subs call
- ok create all code and data as prg files with their visible address (bank0: 0x8000, bank1: 0xA000, startup: 0xE000)

Not used zeropage addresses
- fc, fd, fe, ff (probably temporary variables)
- fb (not found with lda)


- Save Game
    save S:PRTY.DATA (bc00, 0030)
    save S:LIST (4a00, 0200)
    load TLIST
    save S:SLIST (4a00, 0200)
    load LIST
    save S:ROSTER (1000, 0400)

- Create new game
  + insert program
    load
    load FONT3.SHPTBL
    load CREATE1.TXT
    load C1
    load C2
    load C3
    load MAIN.SUBS
  + insert underworld
    load BLANK.ROSTER
    load BLANK.PARTY
    load BLANK.ULIST
    save S:TLIST (4a00, 0200)
  + insert britannia
    save S:ROSTER (1000, 0400)
    save S:PRTY.DATA (bc00, 0030)
    save S:LIST (4a00, 0200)
    save S:SLIST (4a00, 0200)
    load STARTUP
    load MAIN.SUBS
    ...

- Journey Onward (after new game)
    load...
    loads ENTER.PLAY ($8000)
    (change disk BRITANNIA)
    loads PRTY.DATA ($bc00)
    loads SLIST ($4a00)
    save S:TLIST (4a00, 0200)
    loads LIST ($4a00)
    loads ROSTER ($1000) (ROS*)
    (change disk DWELLING)
    loads MAIN.T* ($8000)

- Change to Britannia
     load TLIST
     load MAIN.OUT

- Enter Keep
    load E
    save S:TLIST
    (enter keep)
    load MAIN.TWN

- Leave Keep
    (insert britannia)
    load TLIST
    load MAIN.OUT


File operations
===============
0x6c49 - 0x6f4d

- Load file, get name from return address, x: 0: return, 1: call 0x8000, other call 0xa700
  0x6c24: (0x6c49) load file from disk [6c49 - 6ca9]
  copy file to non bankable area
  bank in directory
  find entry
    depending on inserted disk
    filename    
  set
    offset address in file (0)
    destination address (from file entry)
    bank (from directory entry)
    decrunch necessary (yes)
  load as file
    + bank in
    + read one byte
    + bank out
    + write one byte
    + when finished, decrunch if necessary
  
- Read disk block
0x6c24: (0x6eae) read disk block, Y: track, X: sector, A: address high byte [6eae - 6f41]
  depending on inserted disk:
    set filename
    correct track offset
  calculate offset in file
    (y*16 + x) * 256
  set
    offset address in file (256 steps only)
    destination address (from A and 0)
    bank (from directory entry)
    decrunch necessary (no)
  load as file
  
- Save file [6de0 - 6e6e]
0x6c2d: (0x6de0): save file
  size: 142 bytes

- Change disk
0x6c09 (0x6d47): request disk with text [overwrite 0x6d47 to 6ddf]
  set current disk in file loader
  return success

0x6c2a: (0x6caa): check inserted disk, A is requested disk, return C set disk no inserted [overwrite 6caa - 6cdf, 6ce0-6d46]
  set current disk in file loader
  return success

- Load data
  + needed:
    offset address in file (high byte only)
    destination address (from file entry or provided)
    bank (from directory entry)
    decrunch necessary
  + operation
    bank in
    read one byte
    bank out
    write one byte
    when finished, decrunch if necessary


Loading
=======

1. meow.prg
   loads xyzzy.prg ($2000)
   
2. xyzzy.prg (alternate would be scratch.prg, which will not be loaded)
   drive selection
   many operations, purpose unclear
   loads U5SIZ.O.PRG ($7700) (fastloader)
   loads TEMP.SUBS ($6c00)

3. jumps to TEMP.SUBS
   many operations, purpose unclear
   loads STARTUP
   jumps to STARTUP
   
4. loads PRINT.PRG ($c000)
   loads OSI.LOGOS ($c000)
   loads FLIPPER ($1000)
   loads HTXT ($1580)
   loads INTRO.VIEW ($9500)
   loads U5.PTHTBL ($4000)
   loads S3 ($c000)
   loads S2 ($c000)
   loads S1 ($c000)
   loads UPDATE.HIMEM ($1d80)
   loads COLORS ($b000)
   loads FLAMES ($4000)
   loads U5.LOGO ($c000)
   loads S0 ($c000)
   loads LOGO.COLORS ($1000)
   loads MAIN.SUBS ($4c00)

5. on journey onward: (new game)
   loads ENTER.PLAY ($8000)
   (change disk BRITANNIA)
   loads PRTY.DATA ($bc00)
   loads SLIST ($4a00)
   loads LIST ($4a00)
   loads ROSTER ($1000)
   (change disk DWELLING)
   loads MAIN.T* ($8000)



==============================================================================
Old stuff

Calculation

- 1 5 1/4 disk: 174848 bytes (minus directory): 169984 bytes
- U5 has 8 disks: 1.359.872 bytes
  => we need to find appr 400kB of empty or duplicate blocks

- Disk1: Program
  free: appr 19968 bytes
  
- Disk 2 Dungeon:
  2x 20 empty: 10240 bytes

- Disk 3 Britannia:
  4x 20 empty: 20480 bytes

- Disk 4 Underworld
  4x 20 empty: 20480 bytes

- Disk 5 Towne
  4x 20 empty: 20480 bytes

- Disk 6 Dwelling
  full

- Disk 7: Castle
  3x20 + 11 empty: 19712 bytes

- Disk 8: Keep
  23 blocks: 5888 bytes

=> Free: 117248 bytes

=> Duplicates 360860 bytes

=> sound can be removed on c64 (or maybe can run?)

Overall uncompressed size: 881764 
=> should fit

-----

File Locator:
- assume 255 files, each file has: (compatible to EasyFS)
  + 16 bytes name
       1. byte: diskid (0x41-0x48)
       2. to n. byte: name
  +  1 byte flags 0x60|0x01 (not hidden, type 0x01, normal prg files)
  +  1 byte bank
  +  1 byte reserved
  +  2 byte start offset in bank, 
  +  3 byte file size
  4800 bytes, appr 3300 bytes of code, enough for inventory and code in one 8k page
  saveable files simply point to the correct block
- blocks:
  dungeon: 19 + 11*16 = 195 blocks
  britannia: 272 blocks
  underworld: 272 blocks
  towne: 192 blocks
  dwelling: 192 blocks
  castle: 192 blocks
  keep: 192 blocks
  -> assume 1564 blocks
  block location: 4 byte address: 6144
  simple address resolution disk*256 + x*16 + y 
  or: disk start address fixed + x*16 + y
  about 1024 bytes code
  -> put as large files in efs, and load block with special method (name x)
- saving
  must be redesign at the source:
  first erase and then save all files
  list saving is a problem :(

Files that load other files or do file operations
- Load call
ok Program/meow.prg (1x) -> startup program, will be replaced
ok Program/xyzzy.prg (4x) -> loader, will be changed
ok Program/temp.subs.prg (1x) -> main loading function, will be changed
ok Program/scratch.prg (3x) -> alternative loader with fastloader

- Open call
ok Britannia/q.prg  (1x) -> drive detection
ok Dungeon/main.dng.prg  (1x) -> drive detection
ok Program/scratch.prg (1x) -> alternative loader with fastloader
ok Program/startup.prg (2x) -> will be changed, device 9 related
ok Program/temp.subs.prg (3x) -> load, save, load block, will be changed
ok Program/xyzzy.prg (1x) -> loader, will be changed

-----

- cc65 command to make prg
  + cl65 -o out.prg -t c64 -C config.cfg in.s (config must have startaddress definition)
FEATURES {
    STARTADDRESS:    default = $ff00;
}
SYMBOLS {
    __LOADADDR__:    type = import;
}
MEMORY {
    LOADADDR: file = %O, start = %S - 2, size = $0002;
}

SEGMENTS {
    LOADADDR: load = LOADADDR, type = ro;
}
